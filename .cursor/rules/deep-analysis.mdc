---
name: Deep Analysis Procedure
description: Процедура глубокого анализа перед реализацией изменений
globs: ["**/*"]
alwaysApply: true
---

# Процедура глубокого анализа

**Никогда не начинай писать код без выполнения этого процесса!**

## Шаг 1: Понимание контекста

1. **Прочитать README.md** - понять назначение проекта
2. **Изучить структуру проекта** - понять организацию файлов и модулей
3. **Понять архитектуру** - MVC, сервисный слой, паттерны проектирования

## Шаг 2: Анализ требований

1. **Выделить функциональные требования** - что система должна делать
2. **Выделить нефункциональные требования** - производительность, безопасность, масштабируемость
3. **Уточнить детали у пользователя** - если что-то неясно

## Шаг 3: Изучение существующего кода

1. **Использовать `codebase_search`** - найти похожую функциональность
2. **Использовать `grep`** - найти используемые функции/классы
3. **Прочитать существующие файлы** - понять стиль и паттерны
4. **Понять зависимости** - какие файлы будут затронуты

## Шаг 4: Проверка документации через MCP Context7

1. **PHP функции/классы** - проверить актуальность синтаксиса, параметры
2. **PostgreSQL queries** - проверить правильность SQL синтаксиса, функций
3. **Библиотеки и фреймворки** - проверить актуальность API
4. **OPDS спецификации** - проверить правильность XML формата

## Шаг 5: Веб-поиск для проверки фактов

1. **Актуальность библиотек** - проверить последние версии, изменения
2. **Best practices** - найти современные подходы к решению задачи
3. **Безопасные паттерны** - проверить на уязвимости
4. **Производительность** - найти оптимизационные техники

## Шаг 6: Анализ зависимостей

**Это критически важно!**

1. **Использовать `codebase_search`** - найти все файлы, использующие изменяемые функции/классы
2. **Проверить импорты** - ensure все зависимости корректны
3. **Проверить backward compatibility** - не сломаем ли мы существующий код
4. **Составить список изменений** - какие файлы нужно обновить

## Шаг 7: Планирование

1. **Создать детальный план** - разбить задачу на подзадачи
2. **Определить последовательность** - что за чем делать
3. **Учесть все аспекты** - backend, frontend, database, deployment
4. **Оценить время** - сколько это займет

## Шаг 8: Валидация перед кодом

1. **Проверить синтаксис** через MCP Context7
2. **Проверить факты** через веб-поиск
3. **Проверить логику** - решит ли это проблему?
4. **Проверить границы** - что не входит в scope

## Шаг 9: Реализация

1. **Писать полный код** - никаких заглушек
2. **Добавлять комментарии** на русском языке
3. **Обрабатывать все edge cases**
4. **Добавлять логирование**
5. **Следить за качеством кода** (PSR-12, типизация)

## Шаг 10: Проверка после реализации

1. **Проверить все зависимости** - обновлены ли все затронутые файлы?
2. **Проверить типы** - все ли параметры типизированы?
3. **Проверить обработку ошибок** - все ли исключения обрабатываются?
4. **Проверить безопасность** - нет ли SQL injection/XSS?

## Пример работы

### Плохой подход (без анализа):
```
Пользователь: "Добавь поиск по жанрам"
AI: (сразу пишет код) -> содержит ошибки, не проверил зависимости
```

### Хороший подход (с глубоким анализом):
```
Пользователь: "Добавь поиск по жанрам"
AI:
1. Изучает README.md и структуру OPDS
2. Использует codebase_search для поиска существующего поиска
3. Находит application/opds/search.php
4. Проверяет через MCP Context7 OPDS спецификацию
5. Использует веб-поиск для best practices фильтрации OPDS
6. Находит все файлы, зависящие от поиска (grep/ codebase_search)
7. Составляет план изменения
8. Предлагает решение пользователю
9. После утверждения реализует с полным кодом
```

## Чек-лист перед написанием кода

- [ ] Прочитал README.md?
- [ ] Использовал codebase_search для поиска похожего кода?
- [ ] Проверил синтаксис через MCP Context7?
- [ ] Проверил факты через веб-поиск?
- [ ] Нашел все зависимости (codebase_search/grep)?
- [ ] Составил план изменений?
- [ ] Понял, какие файлы нужно обновить?
- [ ] Проверил backward compatibility?
- [ ] Получил утверждение от пользователя?

**Только после проверки всех пунктов можно писать код!**
