# Система правил Cursor AI для проекта Flibusta

## Обзор

Эта система правил позволяет AI-моделям работать эффективно с проектом Flibusta, обеспечивая:

- ✅ Качественный код без галлюцинаций
- ✅ Глубокий анализ перед реализацией
- ✅ Использование актуальной документации (MCP Context7)
- ✅ Проверка фактов через веб-поиск
- ✅ Ролевое распределение задач
- ✅ Проверка всех зависимостей проекта
- ✅ Полуавтоматический режим работы

## Структура файлов

```text
.cursor/rules/
├── project-core.mdc          # Основные принципы проекта
├── code-quality.mdc          # Стандарты качества кода
├── deep-analysis.mdc          # Процедура глубокого анализа
├── orchestrator.mdc          # Оркестратор и workflow
├── roles/
│   ├── backend.mdc          # Backend Developer роль
│   ├── frontend.mdc         # Frontend Developer роль
│   ├── devops.mdc          # DevOps Engineer роль
│   ├── qa.mdc              # QA Engineer роль
│   ├── analyst.mdc          # Data Analyst роль
│   └── architect.mdc       # Software Architect роль
└── README.md               # Этот файл
```

## Как это работает

### 1. Полуавтоматический режим

AI работает в полуавтоматическом режиме:

```text
Ваш запрос → AI анализирует → AI предлагает решение → Вы утверждаете → AI реализует
```

**Никаких автоматических изменений без вашего утверждения!**

### 2. Глубокий анализ

Перед написанием кода AI всегда выполняет:

1. Анализ контекста проекта
2. Изучение существующего кода
3. Проверка документации через MCP Context7
4. Веб-поиск для актуальной информации
5. Анализ всех зависимостей проекта
6. Планирование изменений

### 3. Ролевая система

AI автоматически определяет нужную роль:

| Тип задачи       | Роль                |
| ---------------- | -------------------- |
| Backend разработка   | Backend Developer     |
| Frontend изменения  | Frontend Developer    |
| Docker/деплой      | DevOps Engineer       |
| Тестирование        | QA Engineer           |
| Производительность    | Data Analyst          |
| Архитектура/планирование | Software Architect  |

### 4. Контроль качества

Перед предложением решения AI проверяет:

- ✅ Синтаксис через MCP Context7
- ✅ Факты через веб-поиск
- ✅ Все зависимости проекта
- ✅ Соответствие стандартам кода

## Как использовать

### Простые запросы

Просто задавайте вопросы или задачи:

```
"Оптимизируй поиск авторов, он работает слишком медленно"
"Добавь возможность фильтрации по языку в OPDS"
"Реализуй dark mode для интерфейса"
```

**ВАЖНО**: Для DevOps задач (перезапуск, бэкапы, обновления) AI предложит команды с запросом разрешения!

```
"Настрой автоматические бэкапы базы данных"
-> AI предложит команды с объяснением рисков и попросит разрешения
```

### Запросы на улучшение

AI может анализировать проект и предлагать улучшения:

```
"Предложи улучшения для мобильной версии"
"Проанализируй производительность приложения"
"Как можно улучшить кодовую базу?"
```

### Детальные запросы

Можно указать конкретную роль:

```
"Как Backend Developer, оптимизируй этот запрос"
"Как Frontend Developer, улучши этот UI"
"Как DevOps Engineer, настрой мониторинг"
```

## Формат предложений

AI всегда представляет решение в структурированном виде:

```markdown
```markdown
## Предложение: [Название]

### Описание
[Что будет сделано]

### Изменения
**Файлы, которые будут изменены:**
- application/module/book/index.php: добавить фильтрацию
- application/opds/search.php: обновить логика

**Затронутые модули:**
- Backend: OPDS endpoint
- Database: новый индекс

### Преимущества
- ✅ Улучшенная производительность
- ✅ Новая функциональность
- ✅ Улучшенный UX

### Риски
- ⚠️ Обратная совместимость: тестирование на старых клиентах

### План реализации
1. Создать индекс в базе данных
2. Обновить OPDS endpoint
3. Добавить тесты
4. Обновить документацию

### Необходимое время
Ориентировочно: 2-3 часа

### Проверка качества
- ✅ Синтаксис проверен через MCP Context7
- ✅ Факты проверены через веб-поиск
- ✅ Зависимости проверены
- ✅ Код соответствует стандартам

---
**Утвердить это предложение?**
```text

## Важные правила для AI

### Обязательные

1. **Всегда использовать MCP Context7** для документации
2. **Всегда применять веб-поиск** для проверки фактов
3. **Никогда не галлюцинировать** - проверять всё
4. **Писать полный код** - никаких заглушек
5. **Проверять все зависимости** при изменениях
6. **Использовать последние версии** библиотек
7. **Писать на русском языке**
8. **Проект развернут на отдельном Linux сервере (Debian, Ubuntu, CentOS)** - не запускать Docker или команды локально
9. **КРИТИЧЕСКИ ВАЖНО**: Пользователь работает на Windows (PowerShell), проект на Linux-сервере - ВСЕ команды должны быть для SSH/Bash, НЕ PowerShell!
10. **Никогда не выполнять команды без разрешения пользователя** - особенно DevOps/Server команды
11. **Полуавтоматический режим** - предлагать, не реализовывать без утверждения

### Запрещенные

❌ Не запускать Docker локально
❌ Не генерировать PowerShell команды для Linux-сервера
❌ Не выполнять команды на сервере без разрешения пользователя
❌ Не предлагать критические команды без предупреждения о рисках
❌ Не писать заглушки (TODO, FIXME)
❌ Не галлюцинировать несуществующие API
❌ Не реализовывать без утверждения
❌ Не проверять только через знания - использовать MCP Context7
❌ Не писать код на английском (кроме терминов)

### Особые правила для DevOps задач

**КРИТИЧЕСКИ ВАЖНО**: Проект Flibusta развернут на отдельном Linux сервере!

#### Категории команд:

**БЕЗОПАСНЫЕ** (можно предложить без разрешения - только чтение):
- Просмотр логов: `docker logs`, `tail -f`
- Проверка статуса: `docker ps`, `systemctl status`
- Мониторинг: `htop`, `df -h`, `free -m`

**ОПАСНЫЕ** (обязательно спрашивать разрешение):
- Перезапуск сервисов: `docker-compose restart`
- Обновление контейнеров: `docker-compose pull && up -d`
- Остановка сервисов: `docker-compose down`
- Изменение конфигураций: редактирование .env, nginx.conf
- Бэкап и восстановление: `pg_dump`, pg_restore`

**КРИТИЧЕСКИЕ** (обязательно объяснять и спрашивать разрешение):
- Удаление данных: `rm -rf`, `DROP TABLE`
- Изменение структуры базы: `ALTER TABLE`, `DROP DATABASE`
- Изменение прав доступа: `chmod`, `chown`
- Настройка firewall: `iptables`, `ufw` commands

## Стандарты качества

### PHP
- PHP 8.1+ с типизацией
- PSR-12 стиль кода
- Prepared statements для SQL
- Валидация входных данных
- Обработка исключений с логированием

### Frontend
- HTML5 семантика
- WCAG 2.1 AA доступность
- Responsive design
- Lazy loading для изображений
- BEM методология для CSS

### Database
- PostgreSQL 14+
- Индексы для производительности
- Параметризованные запросы
- Резервные копии

## Примеры использования

### Пример 1: Оптимизация производительности

```
Вы: "Поиск авторов работает медленно, что можно сделать?"

AI:
1. Анализирует текущий код поиска
2. Проверяет через MCP Context7 оптимизацию PostgreSQL
3. Использует codebase_search для поиска зависимых файлов
4. Предлагает: добавить индексы, оптимизировать запросы, внедрить кэширование

Вы утверждаете → AI реализует полное решение с тестами
```

### Пример 2: Новая фича

```
Вы: "Добавь возможность фильтрации книг по языку в OPDS"

AI (в роли Architect):
1. Проектирует архитектуру фильтрации
2. Создает план изменений

AI (в роли Backend):
3. Реализует фильтрацию на сервере
4. Добавляет параметры в OPDS feeds

AI (в роли QA):
5. Пишет тесты для новой функциональности

AI (в роли Frontend):
6. Обновляет UI если нужно

Вы видите предложение → утверждаете → AI реализует
```

### Пример 3: Анализ и предложения

```
Вы: "Предложи улучшения для проекта"

AI (в роли Analyst):
1. Анализирует метрики производительности
2. Проверяет coverage тестов
3. Ищет технический долг

AI (в роли Architect):
4. Оценивает архитектурные улучшения
5. Создает roadmap

Предлагает: "Вот 5 улучшений, которые я рекомендую:
1. Оптимизировать поиск авторов (оценка: 3 часа)
2. Добавить unit-тесты для OPDS (оценка: 5 часов)
..."

Вы выбираете → AI реализует
```

## Мониторинг качества

AI автоматически проверяет:

- Синтаксис через MCP Context7
- Факты через веб-поиск
- Зависимости через codebase_search
- Соответствие стандартам (PSR-12, WCAG, etc.)

## Траблшутинг

### AI пытается выполнить команды автоматически

Если AI пытается выполнить команды без разрешения:

1. Остановите выполнение
2. Напомните AI: "Проект на другом сервере! Сначала предложи команды с разрешением"
3. Проверьте, что `.cursor/rules/roles/devops.mdc` загружен

### AI пишет код без утверждения

Это не должно происходить! Если вы видите такое:

1. Остановите реализацию
2. Напомните AI о правиле: "Сначала предложи решение, потом реализуй"
3. Проверьте, что `.cursor/rules/orchestrator.mdc` загружен

### AI галлюцинирует

1. Напомните: "Проверь через MCP Context7"
2. Попросите: "Покажи документацию для этого API"
3. Проверьте веб-поиск для актуальности

### AI не проверяет зависимости

1. Напомните: "Проверь все зависимости через codebase_search"
2. Попросите: "Покажи все файлы, которые будут затронуты"

## Обновление правил

Правила обновляются по мере развития проекта:

- Новые технологии → обновить `project-core.mdc`
- Новые стандарты → обновить `code-quality.mdc`
- Новые инструменты → обновить `roles/*.mdc`

## Контакт

Если у вас есть вопросы по работе системы правил:

---

## ⚠️ ВАЖНО: Формат команд для Linux-сервера

**КРИТИЧЕСКИ ВАЖНО**: Вы работаете на Windows (PowerShell), а проект развернут на отдельном Linux-сервере (Debian/Ubuntu/CentOS)!

### Команды должны быть для Linux, НЕ для PowerShell!

#### Что означает для вас:

1. **AI предложит команды** в формате для SSH/Bash на Linux-сервере
2. **Вы подключаетесь к серверу по SSH** (не через Cursor терминал)
3. **Выполняете команды на сервере**
4. **AI никогда не использует PowerShell** - только Bash команды

#### Почему это важно:

- ✅ **Правильно**: Команды для Linux-сервера, выполните на Linux
- ❌ **ОШИБКА**: Команды в PowerShell не сработают на Linux сервере
- ✅ **Правильно**: AI понимает, что вы работаете с Linux-сервером
- ❌ **ОШИБКА**: PowerShell команды (`docker compose`) могут испортить вашу Windows-машину

#### Пример:

**ПРАВИЛЬНЫЙ запрос и ответ:**
```
Вы: "Перезапусти контейнеры на сервере"
AI: "Предлагаю выполнить следующие команды на Linux-сервере через SSH:
```bash
ssh user@your-server.com "cd /path/to/flibusta && docker-compose restart"
```
Риски: сервис будет недоступен ~30 секунд
Вы подтверждаете?"
Вы: "Да"
AI: "Отлично! Выполните команду на сервере через SSH."
```

**ОШИБКА (чтобы избежать):**
```
Вы: "Перезапусти контейнеры"
AI: "docker-compose restart"  # ОШИБКА! Это PowerShell команда!
# Вы пытаетесь выполнить это в Windows терминале Cursor
# Это НЕ сработает на Linux сервере!
```

### Как проверить, что AI использует правильный формат:

#### Хороший знак (✅):
AI предложит:
- Блок кода с командами для SSH
- Комментарии: "через SSH", "на сервере"
- Команды начинаются с `ssh user@server` или `docker-compose` в кавычках
- Предупрежения: "Это нужно выполнить на сервере"

#### Плохой знак (❌):
AI пишет:
- PowerShell команды без кавычек
- Использует `run_terminal_cmd` напрямую
- Не объясняет, что нужно подключиться к серверу
- Пишет команды так, будто их нужно выполнить локально

### Что делать если AI предлагает неверный формат:

Если вы видите команды в неправильном формате (PowerShell вместо Bash):

1. **Напомните**: "Пожалуйста, предложи команды для Linux-сервера через SSH/Bash, а не PowerShell!"
2. **Укажите**: "Я работаю на Windows, проект на Linux-сервере"
3. **Попросите**: "Покажи мне, что команды должны быть в формате: `ssh user@server 'команда'`"

### Ключевые слова для проверки:

AI использует правильный формат (✅):
- `ssh user@server`
- `bash -c`
- `cd /path/to/flibusta`
- `docker-compose restart`
- `pg_dump -h postgres`
- "через SSH"
- "на Linux-сервере"
- "выполните на сервере"

AI использует неверный формат (❌):
- `docker restart` (без объяснения)
- `docker-compose up` (локально)
- `powershell -Command` (явно PowerShell)
- Выполните сейчас (не спрашивает)
- `run_terminal_cmd` (автоматическое выполнение)

---

## Контакт

Если у вас есть вопросы по работе системы правил:

1. Проверьте этот README
2. Прочитайте конкретный `.cursor/rules/role.mdc`
3. Обратитесь к `.cursor/rules/orchestrator.mdc` для workflow

---

**Версия:** 1.0  
**Дата создания:** Декабрь 2024  
**Для:** Flibusta Project  
**Режим:** Полуавтоматический
