services:
    postgres:
        build: phpdocker/pg
        working_dir: /application
        volumes:
            - 'db-data:/var/lib/postgresql/data'
            - './application:/application'
        environment:
            - POSTGRES_USER=${FLIBUSTA_DBUSER:-flibusta}
            - POSTGRES_PASSWORD=${FLIBUSTA_DBPASSWORD:-flibusta}
            - POSTGRES_DB=${FLIBUSTA_DBNAME:-flibusta}
        ports:
            - '${FLIBUSTA_DB_PORT:-27101}:5432'
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${FLIBUSTA_DBUSER:-flibusta} -d ${FLIBUSTA_DBNAME:-flibusta}"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: '2'
                    memory: 4G
                reservations:
                    cpus: '1'
                    memory: 2G
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    webserver:
        image: 'nginx:1.25-alpine'
        working_dir: /application
        command: ["nginx", "-c", "/etc/nginx/nginx.conf", "-g", "daemon off;"]
        volumes:
            - './application:/application'
            - './cache:/application/cache'
            - '${FLIBUSTA_BOOKS_PATH:-./Flibusta.Net}:/application/flibusta'
            - './phpdocker/nginx/nginx.conf:/etc/nginx/nginx.conf'
            - '/var/www/certbot:/var/www/certbot:ro'
            - '/etc/letsencrypt:/etc/letsencrypt:ro'
        ports:
            - '${FLIBUSTA_PORT:-27100}:80'
            - '443:443'
        depends_on:
            php-fpm:
                condition: service_healthy
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: '1'
                    memory: 512M
                reservations:
                    cpus: '0.5'
                    memory: 256M
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    php-fpm:
        build: 
            context: ./phpdocker/php-fpm
            args:
                PHP_VERSION: ${FLIBUSTA_PHP_VERSION:-8.2}
        working_dir: /application
        volumes:
            - './application:/application'
            - './cache:/application/cache'
            - '${FLIBUSTA_BOOKS_PATH:-./Flibusta.Net}:/application/flibusta'
            - '${FLIBUSTA_SQL_PATH:-./FlibustaSQL}:/application/sql'
            - './phpdocker/php-fpm/php-ini-overrides.ini:/usr/local/etc/php/conf.d/local-custom.ini'
            - './phpdocker/php-fpm/php-fpm.conf:/usr/local/etc/php-fpm.d/zz-php-fpm.conf'
            - './scripts:/application/scripts'
        entrypoint: ["sh", "-c", "(if [ -f /run/secrets/FLIBUSTA_PWD ]; then cp /run/secrets/FLIBUSTA_PWD /tmp/flibusta_pwd.txt 2>/dev/null && chmod 644 /tmp/flibusta_pwd.txt 2>/dev/null && chown www-data:www-data /tmp/flibusta_pwd.txt 2>/dev/null || true; fi) && sh /application/scripts/fix_permissions.sh >/dev/null 2>&1 || (mkdir -p /application/cache/tmp /application/cache/authors /application/cache/covers /application/cache/opds /application/sql/psql && chmod -R 777 /application/cache /application/sql/psql 2>/dev/null || true && chown -R www-data:www-data /application/cache 2>/dev/null || true && cd /application/tools && chmod +x *.sh app_topg *.py 2>/dev/null || true) && exec docker-php-entrypoint php-fpm"]
        environment:
            - FLIBUSTA_DBUSER=${FLIBUSTA_DBUSER:-flibusta}
            - FLIBUSTA_DBNAME=${FLIBUSTA_DBNAME:-flibusta}
            - FLIBUSTA_DBTYPE=${FLIBUSTA_DBTYPE:-postgres}
            - FLIBUSTA_DBHOST=${FLIBUSTA_DBHOST:-postgres}
            - FLIBUSTA_PHP_VERSION=${FLIBUSTA_PHP_VERSION:-8.2}
            - FLIBUSTA_DBPASSWORD_FILE=/run/secrets/FLIBUSTA_PWD
        secrets:
            - FLIBUSTA_PWD
        depends_on:
            postgres:
                condition: service_healthy
        healthcheck:
            test: ["CMD-SHELL", "php-fpm -t 2>/dev/null || exit 0"]
            interval: 60s
            timeout: 30s
            retries: 5
            start_period: 60s
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: '2'
                    memory: 2G
                reservations:
                    cpus: '1'
                    memory: 1G
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    # Сервис мониторинга для Prometheus
    monitoring:
        image: 'prom/prometheus:v2.45.0'
        working_dir: /application
        volumes:
            - './application:/application'
            - './configs/prometheus:/etc/prometheus'
            - 'prometheus-data:/prometheus'
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--storage.tsdb.retention.time=15d'
        ports:
            - "${FLIBUSTA_PROMETHEUS_PORT:-9090}:9090"
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: '0.5'
                    memory: 512M
                reservations:
                    cpus: '0.25'
                    memory: 256M
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    # Сервис бэкапов (запускается вручную или по расписанию)
    backup:
        build: 
            context: ./phpdocker/php-fpm
            args:
                PHP_VERSION: ${FLIBUSTA_PHP_VERSION:-8.2}
        working_dir: /application
        volumes:
            - './application:/application'
            - './backup:/backup'
            - './scripts:/application/scripts'
            - './phpdocker/php-fpm/php-ini-overrides.ini:/usr/local/etc/php/conf.d/local-custom.ini'
            - './phpdocker/php-fpm/php-fpm.conf:/usr/local/etc/php-fpm.d/zz-php-fpm.conf'
        environment:
            - FLIBUSTA_DBTYPE=${FLIBUSTA_DBTYPE:-postgres}
            - FLIBUSTA_DBHOST=${FLIBUSTA_DBHOST:-postgres}
            - FLIBUSTA_DBUSER=${FLIBUSTA_DBUSER:-flibusta}
            - FLIBUSTA_DBNAME=${FLIBUSTA_DBNAME:-flibusta}
            - FLIBUSTA_DBPASSWORD_FILE=/run/secrets/FLIBUSTA_PWD
            - FLIBUSTA_BACKUP_DIR=/backup
            - FLIBUSTA_BACKUP_RETENTION=${FLIBUSTA_BACKUP_RETENTION:-30}
        depends_on:
            postgres:
                condition: service_healthy
        restart: "no"
        deploy:
            resources:
                limits:
                    cpus: '1'
                    memory: 1G
                reservations:
                    cpus: '0.5'
                    memory: 512M
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        # Профиль для запуска только по требованию
        profiles:
            - manual


volumes:
    db-data:
    backup:
    prometheus-data:
secrets:
    FLIBUSTA_PWD:
        file: ./secrets/flibusta_pwd.txt
