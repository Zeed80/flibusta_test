services:
    postgres:
        build: phpdocker/pg
        working_dir: /application
        volumes:
            - 'db-data:/var/lib/postgresql/data'
            - './application:/application'
        environment:
            - POSTGRES_USER=${FLIBUSTA_DBUSER:-flibusta}
            - POSTGRES_PASSWORD=${FLIBUSTA_DBPASSWORD:-flibusta}
            - POSTGRES_DB=${FLIBUSTA_DBNAME:-flibusta}
        ports:
            - '${FLIBUSTA_DB_PORT:-27101}:5432'
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${FLIBUSTA_DBUSER:-flibusta} -d ${FLIBUSTA_DBNAME:-flibusta}"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    webserver:
        image: 'nginx:1.25-alpine'
        working_dir: /application
        volumes:
            - './application:/application'
            - './cache:/application/cache'
            - '${FLIBUSTA_BOOKS_PATH:-./Flibusta.Net}:/application/flibusta'
            - './phpdocker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf'
        ports:
            - '${FLIBUSTA_PORT:-27100}:80'
        depends_on:
            php-fpm:
                condition: service_healthy

    php-fpm:
        build: 
            context: ./phpdocker/php-fpm
            args:
                PHP_VERSION: ${FLIBUSTA_PHP_VERSION:-8.2}
        working_dir: /application
        volumes:
            - './application:/application'
            - './cache:/application/cache'
            - '${FLIBUSTA_BOOKS_PATH:-./Flibusta.Net}:/application/flibusta'
            - '${FLIBUSTA_SQL_PATH:-./FlibustaSQL}:/application/sql'
            - './phpdocker/php-fpm/php-ini-overrides.ini:/usr/local/etc/php/conf.d/local-custom.ini'
            - './phpdocker/php-fpm/php-fpm.conf:/usr/local/etc/php-fpm.d/zz-php-fpm.conf'
        environment:
            - FLIBUSTA_DBUSER=${FLIBUSTA_DBUSER:-flibusta}
            - FLIBUSTA_DBNAME=${FLIBUSTA_DBNAME:-flibusta}
            - FLIBUSTA_DBTYPE=${FLIBUSTA_DBTYPE:-postgres}
            - FLIBUSTA_DBHOST=${FLIBUSTA_DBHOST:-postgres}
            - FLIBUSTA_PHP_VERSION=${FLIBUSTA_PHP_VERSION:-8.2}
            - FLIBUSTA_DBPASSWORD_FILE=/run/secrets/FLIBUSTA_PWD
        secrets:
            - FLIBUSTA_PWD
        depends_on:
            postgres:
                condition: service_healthy
        healthcheck:
            test: ["CMD-SHELL", "php-fpm -t 2>/dev/null && pg_isready -U ${FLIBUSTA_DBUSER:-flibusta} -h ${FLIBUSTA_DBHOST:-postgres} -d ${FLIBUSTA_DBNAME:-flibusta} || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s


volumes:
    db-data:
secrets:
    FLIBUSTA_PWD:
        file: ./secrets/flibusta_pwd.txt