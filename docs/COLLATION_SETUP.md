# Настройка русского collation для сортировки

Для правильной сортировки с приоритетом кириллицы над латиницей необходимо создать collation `ru_RU.UTF-8` в PostgreSQL.

## Важно: Требования к правам

Создание collation требует прав **суперпользователя PostgreSQL** (обычно пользователь `postgres`). Если в вашей установке Docker используется другой пользователь (например, `flibusta`), вам нужно:

1. Либо получить права суперпользователя
2. Либо использовать существующие collations (код автоматически переключится)

## Способ 1: Попытка создать collation от текущего пользователя

В вашей установке используется пользователь `flibusta`. Попробуйте создать collation от его имени:

```bash
# Подключитесь к серверу через SSH, затем:
docker-compose exec postgres psql -U flibusta -d flibusta <<EOF
CREATE COLLATION IF NOT EXISTS "ru_RU.UTF-8" (
    LOCALE = 'ru_RU.UTF-8',
    PROVIDER = 'libc'
);
EOF
```

Если получите ошибку `insufficient_privilege` или `permission denied`, переходите к следующим способам.

## Способ 2: Создание через init скрипт (при следующем создании БД)

Если нужно создать collation при инициализации базы данных, добавьте в `phpdocker/pg/init_db.sql` в начало файла:

```sql
-- Создание collation для русской сортировки
-- Выполняется автоматически при создании базы данных (требует прав суперпользователя)
CREATE COLLATION IF NOT EXISTS "ru_RU.UTF-8" (
    LOCALE = 'ru_RU.UTF-8',
    PROVIDER = 'libc'
);
```

**Важно:** Это сработает только если база данных создается заново (при `docker-compose down -v` и `docker-compose up`). **Не делайте этого, если у вас уже есть данные!**

## Способ 3: Использование существующих collations (рекомендуется, если нет прав)

Если создать `ru_RU.UTF-8` невозможно (нет прав или локали), код автоматически использует collation базы данных по умолчанию. Сортировка будет работать, но без специального приоритета кириллицы.

**Это нормально!** Код проверяет доступность collation и автоматически переключается на безопасный режим.

## Проверка доступных collations

```bash
# Проверьте, какие collations доступны в вашей базе:
docker-compose exec postgres psql -U flibusta -d flibusta -f /application/tools/check_collations.sql
```

## Проверка работы кода

Даже без специального collation код будет работать. Проверьте:

```bash
# Проверьте, что код правильно определяет доступность collation:
docker-compose exec postgres psql -U flibusta -d flibusta -c "
SELECT EXISTS (
    SELECT 1 FROM pg_collation WHERE collname = 'ru_RU.UTF-8'
) as collation_exists;
"
```

Если вернется `f` (false), код использует collation по умолчанию.

## Если у вас есть доступ к пользователю postgres

Если в вашей системе PostgreSQL есть пользователь `postgres` с правами суперпользователя:

```bash
# Найдите пароль postgres (обычно в docker-compose.yml или переменных окружения)
docker-compose exec postgres psql -U postgres -d flibusta -c "CREATE COLLATION IF NOT EXISTS \"ru_RU.UTF-8\" (LOCALE = 'ru_RU.UTF-8', PROVIDER = 'libc');"
```

Но если пользователь `postgres` не существует (как в вашем случае), это не сработает.

## Проблемы и решения

### Ошибка: "role postgres does not exist"

**Причина:** В вашей установке Docker используется другой пользователь БД (например, `flibusta`).

**Решение:** 
1. Используйте пользователя `flibusta` (см. Способ 1 выше)
2. Или используйте существующие collations (код автоматически переключится)

### Ошибка: "permission denied to create collation" или "insufficient_privilege"

**Причина:** Пользователь базы данных не имеет прав на создание collation.

**Решение:**
1. **Если это не критично:** Используйте существующие collations (C, POSIX) - код автоматически переключится
2. **Если нужен collation:** Обратитесь к администратору БД или создайте collation через init скрипт при следующем создании БД

### Ошибка: "locale ru_RU.UTF-8 does not exist"

**Причина:** Локаль `ru_RU.UTF-8` не установлена в системе (в контейнере Docker).

**Решение:**
1. Проверьте доступные локали: `docker-compose exec postgres locale -a | grep ru`
2. Если локали нет, код автоматически использует существующие collations
3. Это не критично - код продолжит работать

### Код работает без collation?

**Да, это нормально!** Код автоматически проверяет доступность collation и переключается на безопасный режим. Все функции работают, просто сортировка будет стандартной (без специального приоритета кириллицы).

## Дополнительная информация

- Код автоматически проверяет доступность collation при первом использовании
- Результат проверки кэшируется в памяти класса `OPDSCollation`
- Если collation недоступен, код продолжает работать без ошибок
- Все SQL запросы с сортировкой используют класс `OPDSCollation` для безопасного применения collation

## Рекомендация

Если у вас нет прав суперпользователя PostgreSQL, **используйте существующие collations**. Код автоматически адаптируется и продолжит работать корректно. Сортировка будет стандартной, что вполне приемлемо для большинства случаев.
