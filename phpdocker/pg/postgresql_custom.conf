# PostgreSQL конфигурация для продакшен (консервативная для ограниченных ресурсов)
#
# Адаптировано для сервера с ограниченным диском (~30GB свободно на хосте)
# Для других объёмов памяти: shared_buffers = 25% RAM, effective_cache_size = 50% RAM

#==============================================================================
# ПОДКЛЮЧЕНИЕ ДРУГИХ КОНФИГУРАЦИЙ
#==============================================================================

# Не комментируйте следующую строку, чтобы включить пользовательские настройки
# include 'postgresql_custom.conf'

#==============================================================================
# НАСТРОЙКИ ПАМЯТИ
#==============================================================================

# Суммарная память для PostgreSQL (должна быть меньше доступной RAM)
# Рекомендация: 25% от общего объёма RAM
# Для 8GB RAM: 2GB (снижено до 256MB для экономии места)
# Для 16GB RAM: 4GB (снижено до 512MB для экономии места)
# Для 32GB RAM: 8GB (снижено до 1GB для экономии места)
shared_buffers = 256MB

# Количество общей памяти ядра, которую PostgreSQL использует для кэширования
# Рекомендация: 50% от общего объёма RAM (включая shared_buffers)
# Для 8GB RAM: 4GB (снижено до 512MB для экономии места)
# Для 16GB RAM: 8GB (снижено до 1GB для экономии места)
effective_cache_size = 512MB

# Максимальный объём памяти, выделяемый для каждой операции сортировки/хеширования
# Рекомендация: (RAM - shared_buffers) / max_connections
# Для 8GB RAM с 100 соединениями: ~64MB (снижено до 16MB)
work_mem = 16MB

# Максимальный объём памяти для операций обслуживания (VACUUM, CREATE INDEX)
# Рекомендация: 10-20% от RAM или 512MB-2GB (снижено до 64MB)
maintenance_work_mem = 64MB

# Минимальный объём памяти для сортировки (используется до работы work_mem)
maintenance_operation_mem = 8MB

#==============================================================================
# НАСТРОЙКИ СОЕДИНЕНИЯ
#==============================================================================

# Максимальное количество одновременных клиентских соединений
# Зависит от expected load и количества процессоров
# Рекомендация: 50-200 для веб-приложений (снижено для экономии ресурсов)
max_connections = 50

# Количество рабочих процессов для каждой базы данных (только Linux)
# Рекомендация: равно количеству CPU cores или чуть больше
max_worker_processes = 2

# Максимальное количество рабочих процессов для выполнения запроса
# Рекомендация: (max_worker_processes * 2) - 2 для OLTP (снижено)
max_parallel_workers_per_gather = 2

#==============================================================================
# НАСТРОЙКИ WAL (Write Ahead Log)
#==============================================================================

# Размер буфера WAL в памяти
# Рекомендация: 16MB для большинства систем (снижено для экономии места)
wal_buffers = 16MB

# Частота выполнения WAL checkpoints
# Рекомендация: 0.9 для лучших показателей (более частые, менее затратные)
checkpoint_completion_target = 0.9

# Максимальный размер WAL файлов
# КРИТИЧНО: Снижено с 10GB до 1GB для работы с ограниченным диском
min_wal_size = 80MB
max_wal_size = 1GB

# Минимальный размер WAL файлов
# Рекомендация: 80MB (снижено)
wal_keep_size = 80MB

# Максимальное количество WAL файлов для архивации
# Рекомендация: 0 (бесконечно) или большое число для активного WAL archiving
wal_keep_size = 0

# Включить сжатие WAL (PostgreSQL 13+)
wal_compression = on

# Режим fsync для WAL
# Рекомендация: on для безопасности, off для макс. скорости (оставляем on для безопасности)
fsync = on

# Синхронизация WAL на диск
# Рекомендация: on для безопасности, remote_write для балансировки скорости/безопасности
synchronous_commit = on

#==============================================================================
# НАСТРОЙКИ АВТОВАКУУМА
#==============================================================================

# Включить автоматический вакуум
autovacuum = on

# Максимальное количество рабочих процессов автоваркуума
# Рекомендация: 2-4 в зависимости от CPU cores (снижено до 2)
autovacuum_max_workers = 2

# Частота автоваркуума каждой таблицы
# Рекомендация: 1min для активных систем
autovacuum_naptime = 1min

# Порог для запуска VACUUM ANALYZE
# Рекомендация: 10-20% изменений таблицы
autovacuum_analyze_threshold = 10000

# Порог для запуска VACUUM FULL
# Рекомендация: 20% изменений таблицы (повышено для экономии места)
autovacuum_vacuum_threshold = 20000

# Процент таблицы для запуска VACUUM
# Рекомендация: 10-20% (повышено до 30% для экономии места)
autovacuum_vacuum_scale_factor = 0.3

# Процент таблицы для запуска ANALYZE
# Рекомендация: 5-10%
autovacuum_analyze_scale_factor = 0.1

# Максимальное время выполнения автоваркуума
# Рекомендация: 1 час для предотвращения долгих блокировок (оставляем)
autovacuum_vacuum_cost_limit = -1

#==============================================================================
# НАСТРОЙКИ ЛОГИРОВАНИЯ
#==============================================================================

# Уровень логирования
log_min_messages = warning
log_min_error_statement = error

# Логировать медленные запросы (в миллисекундах)
# Рекомендация: 1000ms (1 секунда) для prod, 100ms для dev
log_min_duration_statement = 500

# Логировать checkpoints
log_checkpoints = on

# Логировать соединения и разъединения
log_connections = on
log_disconnections = on

# Формат логов (csv, json, text)
log_destination = 'stderr'

# Префикс сообщений времени логирования
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Формат даты и времени в логах
log_timezone = 'UTC'

# Включить log_stat_statements для анализа медленных запросов
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 500

#==============================================================================
# НАСТРОЙКИ ПОЛНОТЕКСТОВОГО ПОИСКА
#==============================================================================

# Язык для текстового поиска по умолчанию
default_text_search_config = 'russian'

# Тип конфигурации полнотекстового поиска
# pg_trgm (триграммы) для нечёткого поиска
# pg_trgm - требует расширения pg_trgm
# (создаётся автоматически через CREATE EXTENSION pg_trgm)

#==============================================================================
# НАСТРОЙКИ ЗАПРОСОВ
#==============================================================================

# Метод планирования запросов
# auto, choose, on, off
enable_nestloop = on
enable_hashjoin = on
enable_mergejoin = on

# Уровень подробности explain (0-4)
# Рекомендация: 1 для dev, 0 для prod (безопасность)
log_explain = off

#==============================================================================
# ДРУГИЕ КОНФИГУРАЦИИ
#==============================================================================

# Режим репликации
# off, replica, logical, local
wal_level = replica

# Максимальное количество процессов репликации
# Рекомендация: 2-4 для standby servers
max_wal_senders = 2

# Время ожидания для репликации (в миллисекундах)
wal_sender_timeout = 60000

#==============================================================================
# НАСТРОЙКИ ДЛЯ ОПТИМИЗАЦИИ БОЛЬШИХ ТАБЛИЦ
#==============================================================================

# Порог для использования TOAST (The Oversized-Attribute Storage Technique)
# Поля больше этого значения будут храниться отдельно
# Рекомендация: 2KB
toast_tuple_target = 128

# Максимальный размер страницы TOAST
# Рекомендация: 8KB
default_page_size = 8192

#==============================================================================
# НАСТРОЙКИ И ОГРАНИЧЕНИЯ
#==============================================================================

# Тайм-аут для deadlock detection
# Рекомендация: 1 секунда (1000ms)
deadlock_timeout = 1000

# Максимальное время ожидания блокировки (в миллисекундах)
# Рекомендация: 30 секунд
lock_timeout = 30000

# Включить deadlock detection (всегда включено для prod)
log_lock_waits = off  # Отключено для экономии ресурсов

#==============================================================================
# ОТКЛЮЧЕНИЕ СБОРА СТАТИСТИКИ (для высокого параллелизма)
#==============================================================================

# Параметры сбора статистики можно изменить для улучшения производительности
# но не рекомендуется отключать полностью для prod
# Для экономии ресурсов на слабом железе отключаем:
track_activities = off
track_counts = off
track_io_timing = off
track_functions = none

#==============================================================================
# РАЗНОЕ
#==============================================================================

# Кодировка по умолчанию
client_encoding = 'UTF8'

# Временная зона
timezone = 'UTC'

# Включать ли autocommit (лучше оставить off для явного контроля транзакций)
autocommit = off

# Включать ли statement_timeout для всех подключений (в миллисекундах)
# Рекомендация: 5 минут для предотвращения зависших запросов
statement_timeout = 300000

# Включать ли idle_in_transaction_session_timeout (в миллисекундах)
# Рекомендация: 30 минут для завершения "забытых" транзакций
idle_in_transaction_session_timeout = 1800000

#==============================================================================
# НАСТРОЙКИ СПЕЦИФИЧЕСКИЕ ДЛЯ FLIBUSTA
#==============================================================================

# Увеличенный work_mem для запросов поиска по авторам/книгам
# Эти запросы часто используют сортировку и хеширование
# Используйте SET work_mem = ... в конкретных запросах, если нужно

# Оптимизация для полнотекстового поиска с русским языком
# Требует больше maintenance_work_mem для индексации
# Уже установлено выше: maintenance_work_mem = 64MB

# Количество файлов, которые PostgreSQL держит открытыми
# Рекомендация: увеличить для высокой нагрузки (1000-2000)
# Снижено для экономии памяти
max_files_per_process = 1000

#==============================================================================
# КОНЕЦ КОНФИГУРАЦИИ
#==============================================================================

# После изменения этой конфигурации перезапустите PostgreSQL:
# docker-compose restart postgres
# или
# docker-compose exec postgres pg_ctl reload -D /var/lib/postgresql/data
